# 品質チェックリスト

AIが成果物の品質をレビューする際に使用するチェックリストです。

**前提**: linterでチェック可能な項目（gofmt, golangci-lint等）は自動チェックに任せます。
このリストは、人間の判断が必要な設計・実装パターンのみを対象とします。

**注意**: コミットメッセージは品質チェックの対象外です（開発者の責任範囲）。

## 1. インターフェース設計

- [ ] **単一責任**: 1つのインターフェースは1つの責務に集中しているか
- [ ] **小さいインターフェース**: メソッド数は適切か（理想は1-3）
- [ ] **context.Context**: 最初の引数に配置されているか
- [ ] **適切な抽象化**: インターフェースが実装詳細に依存していないか

詳細は `docs/rules/go-style-guide.md` を参照。

## 2. エラーハンドリング

- [ ] **エラーチェック**: すべてのエラーが適切に処理されているか
- [ ] **エラーラッピング**: `fmt.Errorf` + `%w` でコンテキスト情報を追加しているか
- [ ] **エラーメッセージ**: 小文字開始、簡潔、具体的か

```go
// 良い例
if err := storage.CreateEntry(ctx, entry); err != nil {
    return fmt.Errorf("failed to create entry: %w", err)
}

// 悪い例
storage.CreateEntry(ctx, entry)  // エラー無視
return err  // コンテキスト情報なし
```

## 3. テスト

- [ ] **カバレッジ**: 主要な機能パスがカバーされているか
- [ ] **エッジケース**: 境界値やエラーケースがテストされているか
- [ ] **テーブル駆動**: 複数ケースを効率的にテストしているか
- [ ] **モック**: 外部依存が適切にモック化されているか
- [ ] **エラーチェック**: テストコードでもエラーを無視していないか（`_ = func()` パターン禁止）

```go
// 良い例
if err := repo.CreateDiary("/path/1.jpg", "日記1", time1); err != nil {
    t.Fatalf("CreateDiary failed: %v", err)
}

// 悪い例
_ = repo.CreateDiary("/path/1.jpg", "日記1", time1)  // エラー無視
```

```bash
# カバレッジ確認
go test -cover ./...
```

## 4. セキュリティ

- [ ] **入力検証**: ユーザー入力が検証されているか
- [ ] **パストラバーサル**: ファイルパスが検証されているか
- [ ] **機密情報**: ハードコードされた認証情報がないか
- [ ] **エラー情報**: 詳細すぎる情報を外部に漏らしていないか

```go
// パストラバーサル対策の例
cleanPath := filepath.Clean(userPath)
if !strings.HasPrefix(cleanPath, "/safe/directory/") {
    return errors.New("invalid path")
}
```

## 5. パフォーマンス

- [ ] **context.Context**: タイムアウト・キャンセル処理が実装されているか
- [ ] **ゴルーチンリーク**: ゴルーチンが適切に終了しているか
- [ ] **N+1問題**: データベースクエリのN+1問題がないか
- [ ] **不要なアロケーション**: 明らかな非効率がないか

## 6. UI/UX整合性

- [ ] **一覧の並び順**: フィルタ適用時と全件表示で並び順が一致しているか
- [ ] **表示形式の統一**: 同じデータを表示する複数のコードパスで表示形式が統一されているか

## 7. 依存関係管理

- [ ] **go.mod**: 依存関係が適切に記録されているか
- [ ] **go.sum**: チェックサムが更新されているか
- [ ] **不要な依存**: 使用していない依存関係がないか

```bash
# 依存関係の整理
go mod tidy
```

## 8. 実装ロジックのエッジケース

- [ ] **ゼロ値・nil・空値**: 引数がゼロ値・nil・空文字の場合の動作が定義されているか
- [ ] **Optional引数の組み合わせ**: 複数のOptional引数を持つ場合、全ての組み合わせが考慮されているか
  - 例: `from` のみ、`to` のみ、両方、両方なし の4パターン
- [ ] **境界値の包含・除外**: 範囲指定の境界値が意図通り含まれるか（`<=` vs `<` など）

## 9. データベース操作との一貫性

- [ ] **文字列比較の一貫性**: DB（SQLiteのLIKE等）と言語ネイティブ（strings.Contains等）の比較で大小文字区別が一致しているか
- [ ] **インメモリフィルタ**: DBクエリ結果をさらにコード側でフィルタする場合、DBの挙動と一致しているか

## レビュー手順

1. **変更内容の確認**: `git diff` または `git show`
2. **linterチェック**: `golangci-lint run`（自動チェック）
3. **テスト実行**: `go test ./...`
4. **このチェックリストで設計・実装パターンを確認**（複数コードパスのUI/UX一貫性も含む）
5. **問題があればフィードバック**: `SendMessage` で具体的な改善点を伝える

## 参考資料

- `docs/rules/go-style-guide.md`: Go言語スタイルガイド（設計パターン詳細）
- `docs/rules/commit-message-guide.md`: コミットメッセージガイド（開発者向け）
